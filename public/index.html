<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="description"
    content="A Windows 9x inspired operating system written in Vanilla JS where every HTML file is executable." />
  <meta name="keywords" content="JavaScript, operating system, your browser, retro, Sacred OS, OS, web OS" />
  <meta name="author" content="Mark Valentino" />

  <meta property="og:title" content="Sacred OS" />
  <meta property="og:description"
    content="A Windows 9x inspired operating system written in Vanilla JS where every HTML file is executable." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://sacred.neocities.org" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:image" content="https://sacred.neocities.org/sacred_os_screensot.png" />

  <title>Sacred OS</title>
  <link rel="stylesheet" href="bios.css" />
</head>

<body id="screen">
  <main id="crtAndBootContainer">
    <div class="crtborderHighlight">
      <div class="crtBorder">
        <div class="innerCrtBorder">
          <div id="bootScreen">
            <header class="flexBetween">
              <h1 id="biosTitle">ìç∞ Sacred OS Boot Menu</h1><button id="about" class="biosButton">About</button>
            </header>
            <div id="aboutDialog">
              <p>Sacred OS is a Windows 9x inspired operating system written in Vanilla JS where every HTML
                file is executable. It was created by <a href="https://github.com/M-Valentino/sacredOS">Mark
                  Valentino.</a>
              </p>
              <button id="closeAbout" class="biosButton">Ok</button>
            </div>
            <hr class="biosHrMain mb-20" />
            <section id="bootOptions">
              <div class="biosTextMain">Do you want to boot Sacred OS from your JSON disk backup?</div>
              <button id="uploadJson" class="biosButton mt-20 mr-20">Yes, boot with uploaded disk</button>
              <input type="file" id="fileInput" style="display:none;">
              <button id="defaultSettings" class="biosButton mt-20">No, Continue with fresh install</button>
              <hr class="biosHrSub mt-20" />
            </section>
            <section id="sysChecks">
              <div class="biosTextMain mt-20">System Checks</div>
              <div id="screenRes" class="biosTextSub"></div>
              <div id="screenResWarning" class="warning"></div>
              <div id="inputDev" class="biosTextSub"></div>
              <div id="inputDevWarning" class="warning"></div>
              <div id="CPU" class="biosTextSub"></div>
              <div id="CPUWarning" class="warning"></div>
              <div id="language" class="biosTextSub"></div>
              <div id="languageWarning" class="warning"></div>
              <div id="userAgent" class="biosTextSub"></div>
              <div id="userAgentWarning" class="warning"></div>
            </section>
            <section id="freshInstallInfo">
              <div class="biosTextMain mt-20">Compiling OS From Source</div>
              <div id="compile" class="biosTextSub"></div>
            </section>
          </div>
        </div>
      </div>
    </div>
    <div class="crtStandContainer">
      <div class="standShadow">
        <div class="crtStand" />
      </div>
    </div>
  </main>
  <!-- <footer id="privPol"><a href="/privacyPolicy.html">Privacy Policy</a></footer> -->
  <script>
    document.getElementById("about").addEventListener("click", function () {
      document.getElementById("aboutDialog").style.display = "initial";
    });

    document.getElementById("closeAbout").addEventListener("click", function () {
      document.getElementById("aboutDialog").style.display = "none";
    });

    ////////// System Check Code //////////
    document.getElementById("screenRes").innerHTML =
      "Screen Resolution: <b>" +
      window.innerWidth + "x" + window.innerHeight + "</b>.";
    if (window.innerWidth < 720 || window.innerHeight < 720) {
      document.getElementById("screenResWarning").innerHTML = `<b>Warning</b> Sacred OS doesn't support screen resolutions smaller than 720x720`;
    }

    const message = window.matchMedia("(any-pointer: coarse)").matches ? "device without a mouse or trackpad" : "mouse or trackpad";
    document.getElementById("inputDev").innerHTML = "Detected: <b>" + message + "</b>.";
    if (message !== "mouse or trackpad") {
      document.getElementById("inputDevWarning").innerHTML = `<b>Warning</b> Sacred OS doesn't support your ${message}.`;
    }

    document.getElementById("CPU").innerHTML =
      "Detected: <b>" + navigator.hardwareConcurrency + " logical CPU cores</b>.";
    if (navigator.hardwareConcurrency === 1) {
      document.getElementById("CPUWarning").innerHTML = `<b>Warning</b> Sacred OS might be really slow on your device.`;
    }

    document.getElementById("language").innerHTML =
      "Detected Language: <b>" + navigator.language + "</b>."
    if (navigator.language !== "en-US") {
      document.getElementById("languageWarning").innerHTML = `<b>Warning</b> Sacred OS doesn't support the ${navigator.language} language.`;
    }

    const userAgent = window.navigator.userAgent;
    document.getElementById("userAgent").innerHTML =
      "Detected User Agent: <b>" + window.navigator.userAgent; + "</b>.";
    if (userAgent.includes("Edg")) {
      // Do nothing
    } else if (userAgent.includes("Safari") && !userAgent.includes("Chrome")) {
      document.getElementById("userAgentWarning").innerHTML = `<b>Warning</b> Safari has graphical bugs and does not update the cursor type when it should.`;
    } else if (userAgent.includes("Firefox")) {
      document.getElementById("userAgentWarning").innerHTML = `<b>Warning</b> The retro styled scrollbars in Sacred OS aren't supported in Firefox.`;
    }
    ////////// End of System Check Code //////////

    // The data already here is the file paths for the OS to boot with a fresh install.
    // This gets overwritten when "fileTable.json" is loaded.
    var fileTable = {
      system: [
        "gui.css",
        "gui.frag.html",
        "gui.js",
        "kernel.js",
        "fileTable.json",
        "settings.json",
        {
          icons: [
            "document.json",
            "folder.json",
            "deleteIndicator.json"
          ]
        }
      ],
      programs: [
        "files.html",
        "doug.html",
        "youTubeFilter.html",
        "notepad.html",
        "calculator.html",
        "tetrJS.html",
        "mBO.html",
        "appStore.html",
        "browser.html",
        "settings.html",
        "about.html",
      ],
      documents: [
        "message.txt"
      ]
    };

    var fileContents = "";
    let defaultFileContents = "";

    document.getElementById("uploadJson").addEventListener("click", function () {
      document.getElementById("fileInput").click();
    });

    document.getElementById("fileInput").addEventListener("change", async function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          fileContents = JSON.parse(e.target.result);
          await afterFileContentLoaded();
        };
        reader.readAsText(file);
      }
    });

    document.getElementById("defaultSettings").addEventListener("click", async function () {
      const bootOptions = document.getElementById("bootOptions");
      bootOptions.remove()
      defaultFileContents = await loadfileContents(fileTable);
      fileContents = defaultFileContents;
      afterFileContentLoaded();
    });

    async function fetchContent(fileURL) {
      try {
        let time = new Date().getTime();
        // Hack to disable loading from cached files
        const response = await fetch(`${fileURL}?t=${time}`);
        if (response.ok) {
          const content = await response.text();
          return content;
        } else {
          console.error(`Error fetching file ${fileURL}: HTTP status ${response.status}`);
        }
      } catch (err) {
        console.error(`Error fetching file ${fileURL}: ${err}`);
      }
    }

    let lineCount = 0;
    const compileElement = document.getElementById("compile");

    async function loadfileContents(fileTable, basePath = '') {
      document.getElementById("sysChecks").style.display = "none";
      document.getElementById("freshInstallInfo").style.display = "initial";
      let tempFileContent = {};
      let tempObjectConent = {};

      for (let key in fileTable) {
        if (Array.isArray(fileTable[key])) {
          tempFileContent[key] = {};
          for (let item of fileTable[key]) {
            if (typeof item === 'string') {
              let fileURL = `${basePath}${key}/${item}`;
              tempFileContent[key][item] = await fetchContent(fileURL);

              // Append line and increment line count
              compileElement.innerHTML += `<div>Loaded: ${fileURL}</div>`;
              lineCount++;

              // Remove lines if more than 18 are present
              while (lineCount > 18) {
                compileElement.removeChild(compileElement.firstChild);
                lineCount--;
              }
            } else if (typeof item === 'object') {
              for (let nestedKey in item) {
                tempObjectConent = tempFileContent;
                tempObjectConent[key][nestedKey] = await loadfileContents({ [nestedKey]: item[nestedKey] }, `${basePath}${key}/`);
                tempFileContent[key][nestedKey] = tempObjectConent[key][nestedKey][nestedKey];
              }
            }
          }
        }
      }

      return tempFileContent;
    }

    async function afterFileContentLoaded() {
      // Check if fileContents are loaded
      if (fileContents && fileContents.system) {
        if (fileContents.system['gui.frag.html']) {
          let guiHTML = document.createElement('div');
          guiHTML.innerHTML = fileContents.system['gui.frag.html'];
          document.body.appendChild(guiHTML);
          // Hide user prompt and show main menu
          document.getElementById("crtAndBootContainer").style.display = "none";
        }
        if (fileContents.system['gui.css']) {
          let styleElement = document.createElement('style');
          styleElement.type = 'text/css';
          styleElement.innerText = fileContents.system['gui.css'];
          document.head.appendChild(styleElement);
        }
        if (fileContents.system['gui.js']) {
          let guiScript = document.createElement('script');
          guiScript.type = 'text/javascript';
          guiScript.textContent = fileContents.system['gui.js'];
          document.body.appendChild(guiScript);
        }
        if (fileContents.system['kernel.js']) {
          let kernelScript = document.createElement('script');
          kernelScript.type = 'text/javascript';
          kernelScript.textContent = fileContents.system['kernel.js'];
          document.body.appendChild(kernelScript);
        }
        if (fileContents.system['fileTable.json']) {
          fileTable = JSON.parse(fileContents.system['fileTable.json']);
          populateMenu();
        }
      }
    }

  </script>

</body>

</html>