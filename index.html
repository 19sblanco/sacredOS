<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="system/gui.css">
</head>

<body>

  <div id="mainMenu">
    <div class="menuHeader">Sacred OS</div>
    <div id="menuContent" class="osElemBase"></div>
  </div>
  <div id="programBar" class="osElemBase">
    <button id="menuButton" class="osElemBase oSButton" onclick="toggleOpenmenu()">~Menu~</button>
  </div>

  <script>
    var fileTable = {
      system: [
        "gui.css",
      ],
      programs: [
        "settings.html",
        "files.html"
      ]
    };

    var fileContents;

    async function loadFilesContent(fileTable) {
      let filesContent = {};

      for (let directory in fileTable) {
        filesContent[directory] = {}; // Initialize a nested object for the directory

        for (let fileName of fileTable[directory]) {
          // Construct the full URL for each file
          let fileURL = `${directory}/${fileName}`;
          try {
            // Fetch file content asynchronously
            let response = await fetch(fileURL);
            if (response.ok) {
              let content = await response.text();
              // Store the content within the nested structure, matching the original
              filesContent[directory][fileName] = content;
            } else {
              console.error(`Error fetching file ${fileURL}: HTTP status ${response.status}`);
            }
          } catch (err) {
            console.error(`Error fetching file ${fileURL}: ${err}`);
          }
        }
      }

      return filesContent;
    }

    function populateMenu() {
      for (let i = 0; i < fileTable.programs.length; i++) {
        var menuItem = document.createElement('div');
        menuItem.innerHTML = fileTable.programs[i];
        menuItem.classList = "oSButton osElemBase";
        menuItem.onclick = menuItem.onclick = (function (programName) {
          return function () {
            openProgram(programName, fileContents.programs[programName]);
          };
        })(fileTable.programs[i]);
        document.getElementById("menuContent").appendChild(menuItem);
      }
    }

    (async function initialize() {
      fileContents = await loadFilesContent(fileTable);
      console.log(fileContents); // This ensures fileContents is logged after being populated.
      populateMenu(); // Ensure this is called after fileContents is populated.
    })()


    var menuOpen = false;
    function toggleOpenmenu() {
      menuOpen = !menuOpen;
      if (menuOpen) {
        document.getElementById("mainMenu").style.display = "initial";
      } else {
        document.getElementById("mainMenu").style.display = "none";
      }
    }

    var windowCount = -1;

    function openProgram(path, data) {
      toggleOpenmenu();
      windowCount++;

      var window = document.createElement('div');
      window.id = `win${windowCount}`;
      window.classList = "window";
      document.body.appendChild(window);

      var header = document.createElement('div');
      header.id = `hed${windowCount}`;
      header.classList = "menuHeader";
      header.textContent = path;
      window.appendChild(header);

      var closeButton = document.createElement('button');
      closeButton.id = `close${windowCount}`; // Unique ID for the close button
      closeButton.classList = "osElemBase oSButton";
      closeButton.textContent = "X";
      closeButton.style.float = "right";
      closeButton.onclick = function () {
        closeProgram(`win${windowCount}`);
      };
      header.appendChild(closeButton);

      // Create a transparent overlay but don't add it to the document yet
      var overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.cursor = 'grabbing';
      overlay.style.zIndex = '9999'; // Ensure it's on top of everything
      overlay.style.display = 'none'; // Start hidden

      document.body.appendChild(overlay);

      header.addEventListener('mousedown', function (e) {
        if (e.target === closeButton) {
          return; // Don't start dragging if clicking on the close button
        }
        e.preventDefault(); // Prevent any default actions that might interfere with the drag
        overlay.style.display = 'block'; // Show the overlay
        let rect = window.getBoundingClientRect();
        var dragOffsetX = e.clientX - rect.left;
        var dragOffsetY = e.clientY - rect.top;

        function onMouseMove(e) {
          window.style.position = 'absolute';
          window.style.left = e.clientX - dragOffsetX + 'px';
          window.style.top = e.clientY - dragOffsetY + 'px';
        }

        function onMouseUp() {
          overlay.style.display = 'none'; // Hide the overlay
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });

      var iframe = document.createElement('iframe');
      iframe.srcdoc = data;
      iframe.width = "100%";
      iframe.height = "100%";
      iframe.frameBorder = '0';
      iframe.style.border = '0';
      iframe.style.overflow = "hidden";
      iframe.style.zIndex = '1';
      iframe.allowFullscreen = true;
      window.appendChild(iframe);
    }

    function closeProgram(id) {
      document.getElementById(id).outerHTML = "";
    }

    function sendMessageToAllIframes(message) {
      const iframes = document.getElementsByTagName('iframe');
      for (let i = 0; i < iframes.length; i++) {
        iframes[i].contentWindow.postMessage(message, '*'); // Use '*' for targetOrigin if you don't know the domain
      }
    }


    window.onmessage = function (e) {
      if (e.data == "REQ:AF") {
        sendMessageToAllIframes("AF:" + JSON.stringify(fileContents), '*');
        return;
      }
      try {
        eval(decodeURI(e.data));
      } catch (e) { }
    };

  </script>

</body>

</html>