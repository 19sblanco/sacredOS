<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <style>
    #screen {
      background-color: #000;
      overflow: hidden;
    }

    #bootScreen {
      margin: auto;
      width: 90vw;
      height: 90vh;
      background-color: #00a;
      padding: 20px;
    }

    .biosButton {
      background-color: transparent;
      border: 6px solid #ff0;
      border-style: double;
      font-size: 18px;
      padding: 4px;
      cursor: pointer;
      color: #fff;
      margin-right: 20px;
      margin-top: 40px;
      letter-spacing: 1px;
    }

    .biosText {
      font-size: 24px;
      font-family: 'Courier New', Courier, monospace;
      color: #fff;
    }

    #biosTitle {
      letter-spacing: 4px;
      font-size: 48px;
      color: #fff;
      font-weight: 600;
    }
  </style>
</head>

<body id="screen">
  <div id="bootScreen">
    <div id="biosTitle">Sacred OS Boot Menu</div>
    <div class="biosText">░▒▒▓▓▓████▓▓▓▒▒░▒▒▓▓▓████▓▓▓▒▒░▒▒▓▓▓████▓▓▓▒▒░▒▒▓▓▓████▓▓▓▒▒░</div>
    <div class="biosText">Do you want to boot Sacred OS from your JSON disk backup?</div>
    <button id="uploadJson" class="biosButton">Yes, boot with uploaded disk</button>
    <button id="defaultSettings" class="biosButton">Continue with fresh install</button>
    <input type="file" id="fileInput" style="display:none;">
  </div>

  <div id="mainMenu">
    <div class="menuHeader">Sacred OS</div>
    <div id="menuContent" class="osElemBase"></div>
  </div>
  <div id="programBar" class="osElemBase">
    <button id="menuButton" class="osElemBase oSButton h-100" onclick="toggleOpenmenu()">~Menu~</button>
    <div id="clock"></div>
  </div>

  <script>
    // Hide until user decides to upload JSON or not
    document.getElementById("mainMenu").style.display = "none";
    document.getElementById("programBar").style.display = "none";

    var fileTable = {
      system: [
        "gui.css",
        {
          icons: [
            "document.json",
            "folder.json",
          ]
        }
      ],
      programs: [
        "files.html",
        "doug.html",
        "settings.html",
      ]
    };

    var fileContents = "";
    var defaultFileContents = "";

    document.getElementById("uploadJson").addEventListener("click", function () {
      document.getElementById("fileInput").click();
    });

    document.getElementById("fileInput").addEventListener("change", async function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          fileContents = JSON.parse(e.target.result);
          await afterFileContentLoaded(); // Call after content loaded
        };
        reader.readAsText(file);
      }
    });

    document.getElementById("defaultSettings").addEventListener("click", async function () {
      defaultFileContents = await loadfileContents(fileTable); // Load default contents here
      fileContents = defaultFileContents; // Assign loaded contents to fileContents
      afterFileContentLoaded(); // Call after content loaded
    });

    async function fetchContent(fileURL) {
      try {
        let response = await fetch(fileURL);
        if (response.ok) {
          let content = await response.text();
          return content;
        } else {
          console.error(`Error fetching file ${fileURL}: HTTP status ${response.status}`);
        }
      } catch (err) {
        console.error(`Error fetching file ${fileURL}: ${err}`);
      }
    }

    async function loadfileContents(fileTable, basePath = '') {
      let tempFileContent = {};
      let tempObjectConent = {};

      for (let key in fileTable) {
        if (Array.isArray(fileTable[key])) {
          tempFileContent[key] = {};
          for (let item of fileTable[key]) {
            if (typeof item === 'string') {
              let fileURL = `${basePath}${key}/${item}`;
              tempFileContent[key][item] = await fetchContent(fileURL);
            } else if (typeof item === 'object') {
              for (let nestedKey in item) {
                tempObjectConent = tempFileContent;
                tempObjectConent[key][nestedKey] = await loadfileContents({ [nestedKey]: item[nestedKey] }, `${basePath}${key}/`);
                tempFileContent[key][nestedKey] = tempObjectConent[key][nestedKey][nestedKey];
              }
            }
          }
        }
      }

      return tempFileContent;
    }

    function populateMenu() {
      for (let i = 0; i < fileTable.programs.length; i++) {
        var menuItem = document.createElement('div');
        menuItem.innerHTML = fileTable.programs[i];
        menuItem.classList = "oSButton osElemBase";
        menuItem.onclick = menuItem.onclick = (function (programName) {
          return function () {
            openProgram(programName, fileContents.programs[programName], true);
          };
        })(fileTable.programs[i]);
        document.getElementById("menuContent").appendChild(menuItem);
      }
    }

    async function afterFileContentLoaded() {
      // Hide user prompt and show main menu
      document.getElementById("bootScreen").style.display = "none";
      document.getElementById("programBar").style.display = "initial";
      // Check if fileContents and the necessary CSS content are loaded
      if (fileContents && fileContents.system && fileContents.system['gui.css']) {
        var styleElement = document.createElement('style');
        styleElement.type = 'text/css';
        styleElement.innerText = fileContents.system['gui.css'];
        document.head.appendChild(styleElement);
      }
      populateMenu();

    }

    var menuOpen = false;
    function toggleOpenmenu() {
      menuOpen = !menuOpen;
      if (menuOpen) {
        document.getElementById("mainMenu").style.display = "initial";
        document.getElementById("menuButton").style.border = "var(--borderWidth) inset var(--secColorDark)";
      } else {
        document.getElementById("mainMenu").style.display = "none";
        document.getElementById("menuButton").style.border = "var(--borderWidth) outset var(--secColorDark)";
      }
    }

    var windowCount = -1;

    function openProgram(programName, data, dontToggleMenu) {
      if (dontToggleMenu) {
        toggleOpenmenu();
      }
      windowCount++;
      const currentWindowID = windowCount;

      var window = document.createElement('div');
      window.id = `win${currentWindowID}`;
      window.style.zIndex = '5';
      window.classList = "window windowRidgeBorder";
      document.body.appendChild(window);

      var header = document.createElement('div');
      header.id = `hed${currentWindowID}`;
      header.classList = "menuHeader";
      header.textContent = programName;
      window.appendChild(header);

      var closeButton = document.createElement('button');
      closeButton.id = `close${currentWindowID}`; // Unique ID for the close button
      closeButton.classList = "osElemBase oSButton windowControlButton";
      closeButton.textContent = "X";
      closeButton.style.float = "right";
      closeButton.onclick = function () {
        closeProgram(`win${currentWindowID}`, `men${currentWindowID}`);
      };
      header.appendChild(closeButton);

      const sizeMatch = data.match(/<!--width="(\d+)" height="(\d+)"-->/);
      const width = sizeMatch ? sizeMatch[1] : '600';
      const height = sizeMatch ? sizeMatch[2] : '400';

      var maximizeButton = document.createElement('button');
      maximizeButton.id = `max${currentWindowID}`; // Unique ID for the close button
      maximizeButton.classList = "osElemBase oSButton windowControlButton";
      maximizeButton.textContent = "[ ]";
      maximizeButton.style.float = "right";
      maximizeButton.onclick = function () {
        toggleMaximizeProgram(`win${currentWindowID}`, `prog${currentWindowID}`, `max${currentWindowID}`, width, height);
      };
      header.appendChild(maximizeButton);

      var minimizeButton = document.createElement('button');
      minimizeButton.id = `max${currentWindowID}`; // Unique ID for the close button
      minimizeButton.classList = "osElemBase oSButton windowControlButton";
      minimizeButton.textContent = "__";
      minimizeButton.style.float = "right";
      minimizeButton.onclick = function () {
        minimizeProgram(`win${currentWindowID}`, `men${currentWindowID}`);
      };
      header.appendChild(minimizeButton);

      // Create a transparent overlay but don't add it to the document yet
      var overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.cursor = 'grabbing';
      overlay.style.zIndex = '9999'; // Ensure it's on top of everything
      overlay.style.display = 'none'; // Start hidden

      document.body.appendChild(overlay);

      header.addEventListener('mousedown', function (e) {
        if (e.target === closeButton || e.target === maximizeButton || e.target === minimizeButton) {
          return; // Don't start dragging if clicking on the close button
        }
        bringWindowToFront(`win${currentWindowID}`, `men${currentWindowID}`);
        e.preventDefault(); // Prevent any default actions that might interfere with the drag
        overlay.style.display = 'block'; // Show the overlay
        let rect = window.getBoundingClientRect();
        var dragOffsetX = e.clientX - rect.left;
        var dragOffsetY = e.clientY - rect.top;

        function onMouseMove(e) {
          window.style.position = 'absolute';
          window.style.left = e.clientX - dragOffsetX + 'px';
          window.style.top = e.clientY - dragOffsetY + 'px';
        }

        function onMouseUp() {
          overlay.style.display = 'none'; // Hide the overlay
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });

      var iframe = document.createElement('iframe');
      iframe.id = `prog${currentWindowID}`;
      iframe.srcdoc = data;
      iframe.width = width;
      iframe.height = height;
      iframe.style.overflow = "hidden";
      iframe.frameBorder = '0';
      iframe.style.border = '0';
      iframe.allowFullscreen = true;
      window.appendChild(iframe);

      var menuBarButton = document.createElement('button');
      menuBarButton.id = `men${currentWindowID}`;
      menuBarButton.classList = "osElemBase oSButton h-100";
      menuBarButton.style.border = "var(--borderWidth) inset var(--secColorDark)";
      menuBarButton.textContent = programName;
      menuBarButton.addEventListener('mousedown', function (e) {
        bringWindowToFront(`win${currentWindowID}`, `men${currentWindowID}`);
      });
      document.getElementById("programBar").appendChild(menuBarButton);

      bringWindowToFront(`win${currentWindowID}`, `men${currentWindowID}`);
    }

    function closeProgram(windowID, menuBarButtonID) {
      document.getElementById(windowID).outerHTML = "";
      document.getElementById(menuBarButtonID).outerHTML = "";
    }

    function toggleMaximizeProgram(windowID, programID, maximizeButtonID, width, height) {
      if (document.getElementById(maximizeButtonID).textContent === "[ ]") {
        document.getElementById(windowID).style.width = "100%";
        document.getElementById(windowID).style.height = "calc(100vh - var(--programBarHeight))";
        document.getElementById(windowID).style.left = 0;
        document.getElementById(windowID).style.top = 0;
        document.getElementById(programID).style.width = "100%";
        document.getElementById(programID).style.height = "calc(100vh - var(--programBarHeight))";
        document.getElementById(maximizeButtonID).textContent = "[]";
      } else {
        document.getElementById(windowID).style.width = width + "px";
        document.getElementById(windowID).style.height = height + "px";
        document.getElementById(maximizeButtonID).textContent = "[ ]";
      }
    }

    function minimizeProgram(windowID, menuButtonID) {
      document.getElementById(windowID).style.display = "none";
      document.getElementById(menuButtonID).style.border = "var(--borderWidth) outset var(--secColorDark)";
    }

    function bringWindowToFront(winID, buttID) {
      document.getElementById(winID).style.display = "initial";
      const windows = document.querySelectorAll('div[id^="win"]');
      windows.forEach(function (win) {
        // If the id matches the specified window, bring it to the front
        if (win.id === winID) {
          win.style.zIndex = '5';
          win.style.boxShadow = "10px 10px 0 0 rgba(0,0,0,0.25)";
        } else {
          win.style.zIndex = '4';
          win.style.boxShadow = "4px 4px 0 0 rgba(0,0,0,0.25)";
        }
      });
      document.getElementById(buttID).style.border = "var(--borderWidth) inset var(--secColorDark)";
    }

    function sendMessageToAllIframes(message) {
      const iframes = document.getElementsByTagName('iframe');
      for (let i = 0; i < iframes.length; i++) {
        iframes[i].contentWindow.postMessage(message, '*');
      }
    }

    function updatePrimaryColor(newColor) {
      const regex = /(--primColor: ).*?;/;
      fileContents.system['gui.css'] = fileContents.system['gui.css'].replace(regex, `$1 ${newColor};`);
    }

    function updateSecondaryColor(newColor) {
      const regex = /(--secColor: ).*?;/;
      fileContents.system['gui.css'] = fileContents.system['gui.css'].replace(regex, `$1 ${newColor};`);
    }

    window.onmessage = function (e) {
      if (typeof e.data === 'string') { // Ensure e.data is a string
        if (e.data == "REQ:AF") {
          sendMessageToAllIframes("AF:" + JSON.stringify(fileContents), '*');
          return;
        } else if (e.data.startsWith("U:PRIMC")) {
          var jsonString = e.data.substring(7);
          updatePrimaryColor(jsonString);
          return;
        } else if (e.data.startsWith("U:SECC")) {
          var jsonString = e.data.substring(6);
          updateSecondaryColor(jsonString);
          return;
        } else if (e.data == "REQ:SS") {
          if (fileContents.system && fileContents.system['gui.css']) {
            e.source.postMessage("SS:" + fileContents.system['gui.css'], '*');
          }
          return;
        } else if (e.data.startsWith("OP:")) {
          try {
            const message = JSON.parse(e.data.substring(3));
            if (message.action && message.action === "openProgram" && message.params) {
              const { fileName, fileData } = message.params;
              openProgram(fileName, fileData, false);
            }
          } catch (error) {
            console.error('Error parsing message:', error);
          }
        }
      }
      try {
        if (typeof e.data === 'string') { // Ensure e.data is a string for eval
          eval(decodeURI(e.data));
          console.log(e.data);
        }
      } catch (e) { }
    };

    // https://www.w3schools.com/js/tryit.asp?filename=tryjs_timing_clock
    function checkTime(i) {
      if (i < 10) { i = "0" + i };
      return i;
    }

    function updateClock() {
      const today = new Date();
      let h = today.getHours();
      let m = today.getMinutes();
      let s = today.getSeconds();
      m = checkTime(m);
      s = checkTime(s);
      document.getElementById("clock").innerHTML = h + ":" + m + ":" + s;
    }
    setInterval(updateClock, 1000);

  </script>

</body>

</html>